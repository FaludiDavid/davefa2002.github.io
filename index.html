import pandas as pd
import plotly.graph_objects as go
from pycoingecko import CoinGeckoAPI
import datetime

# 1) CoinGecko API-ról lekérjük a bitcoin árfolyamot 5 évre visszamenőleg
cg = CoinGeckoAPI()

# Dátumok UNIX timestamp formátumban
end_date = int(datetime.datetime.now().timestamp())
start_date = int((datetime.datetime.now() - datetime.timedelta(days=5 * 365)).timestamp())

# Lekérés USD-ben
data = cg.get_coin_market_chart_range_by_id(
    id='bitcoin',
    vs_currency='usd',
    from_timestamp=start_date,
    to_timestamp=end_date
)

# 2) Átalakítás DataFrame-é
prices = data['prices']  # timestamp + ár
btc_data = pd.DataFrame(prices, columns=['timestamp', 'Price'])

# 3) Dátum konvertálása
btc_data['Date'] = pd.to_datetime(btc_data['timestamp'], unit='ms')
btc_data = btc_data[['Date', 'Price']]  # csak a szükséges oszlopok

# 4) Napi átlagos záróár (mert órás bontásban jön az adat)
btc_data = btc_data.set_index('Date').resample('D').mean().reset_index()

# 5) Hover szöveg összeállítása
btc_data['hover_text'] = btc_data.apply(
    lambda row: (
        f"Dátum: {row['Date'].strftime('%Y-%m-%d')}<br>"
        f"Záróár: ${row['Price']:,.2f}"
    ),
    axis=1
)

# 6) Interaktív vonaldiagram Plotly-jal
fig = go.Figure(
    go.Scatter(
        x=btc_data['Date'],
        y=btc_data['Price'],
        mode='lines',
        line=dict(color='darkorange', width=0.6),
        hovertext=btc_data['hover_text'],
        hoverinfo='text'
    )
)

# 7) Címek és hovermode beállítása
fig.update_layout(
    title="Bitcoin árfolyam időbeli alakulása (CoinGecko API alapján)",
    xaxis_title="Dátum",
    yaxis_title="Záróár (USD)",
    template="simple_white",
    hovermode="x unified"
)

fig.show()
